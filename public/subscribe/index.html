<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <meta name="theme-color" content="#40007f"/>

        <title>Subscribe | ECHL Alerts</title>
        <meta name="description" content="Enable push notifications for your selected ECHL teams.">

        <link rel="stylesheet" href="/css/base.css">

        <!-- Favicons / PWA -->
        <link rel="icon" href="/favicon.ico" sizes="any"/>
        <link rel="apple-touch-icon" href="/icon-192.png"/>
        <link rel="manifest" href="/manifest.json"/>

        <!-- Tailwind CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
    </head>

    <body class="h-screen w-screen overflow-hidden bg-black text-white">
        <!-- Fixed Background (attached) -->
        <div class="fixed inset-0 -z-10 [background:radial-gradient(125%_125%_at_50%_10%,#000_40%,#40007f_100%)]"></div>

        <!-- Sticky Header -->
        <header class="sticky top-0 z-50 h-24 border-b border-white/20 bg-gray-900/80 p-4 backdrop-blur">
            <div class="mx-auto flex max-w-5xl items-center justify-between">
                <div class="flex items-center divide-x-2 divide-white/20">
                    <a href="https://echl.com/transactions" target="_blank" rel="noreferrer">
                        <img src="/echl-logo.svg"
                 class="h-14 w-auto cursor-pointer px-4 drop-shadow-[0_0_8px_rgb(255,255,255,0.3)] hover:drop-shadow-[0_0_8px_rgb(255,255,255,0.5)]"/>
                    </a>
                    <a href="https://royalshockey.com/team/roster" target="_blank" rel="noreferrer">
                        <img src="/reading-royals-logo.svg"
                 class="h-16 w-auto cursor-pointer px-4 drop-shadow-[0_0_8px_rgb(255,255,255,0.3)] hover:drop-shadow-[0_0_8px_rgb(255,255,255,0.5)]"/>
                    </a>
                </div>

                <a href="/" class="text-2xl font-bold hover:text-[#ae9ccb] hidden md:block">
                    ECHL Transactions
                </a>

                <nav class="flex gap-4">
                    <a href="/" class="rounded-xl bg-white/20 px-4 py-2 text-lg font-semibold hover:bg-[#5C3896]">Latest</a>
                    <a href="/subscribe" class="rounded-xl bg-white/20 px-4 py-2 text-lg font-semibold hover:bg-[#5C3896]">Subscribe</a>
                </nav>
            </div>
        </header>

        <!-- Scroll Region: MAIN + FOOTER -->
        <div class="flex h-[calc(100vh-6rem)] flex-col overflow-y-auto">
            <main class="flex-1">
                <div class="mx-auto max-w-5xl px-4 py-8 text-center">
                    
<div class="mx-auto max-w-lg p-6">
  <div class="rounded-2xl bg-gray-800 p-6 shadow-sm ring-1 ring-slate-200">
    <h1 class="text-3xl font-bold">Enable Transaction Alerts</h1>

    <div class="mt-6 space-y-6 text-left">
      <div class="flex flex-col w-full">
        <label class="text-lg font-medium">First Name</label>
        <input id="firstName" autocomplete="first-name"
          class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 outline-none focus:ring-2 focus:ring-slate-200 bg-gray-700"/>
      </div>

      <div class="flex flex-col w-full">
        <label class="text-lg font-medium">Last Name</label>
        <input id="lastName" autocomplete="last-name"
          class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 outline-none focus:ring-2 focus:ring-slate-200 bg-gray-700"/>
      </div>

      <div class="flex flex-col w-full">
        <label class="text-lg font-medium">Email Address</label>
        <input id="email" type="email" autocomplete="email"
          class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 outline-none focus:ring-2 focus:ring-slate-200 bg-gray-700"/>
      </div>

      <div>
        <button id="enable"
        class="w-full rounded-xl mt-4 px-4 py-2 text-lg font-semibold bg-[#5C3896] hover:bg-[#4a2d78]">
          Enable Alerts
        </button>
      </div>

      <div id="status" class="text-base"></div>
    </div>
  </div>
</div>

<script>
  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding)
      .replace(/-/g, "+")
      .replace(/_/g, "/");
    const raw = atob(base64);
    return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
  }

  const statusEl = document.getElementById("status");
  function setStatus(msg, cls = "") {
    statusEl.textContent = msg;
    statusEl.className = "text-sm " + (
      cls === "error"
      ? "text-red-700"
      : cls === "success"
        ? "text-emerald-700"
        : "text-slate-700");
  }

  async function getVapidPublicKey() {
    const res = await fetch("/.netlify/functions/config");
    if (!res.ok) 
      throw new Error("Could not load VAPID public key");
    const json = await res.json();
    if (
      !json
      ?.vapidPublicKey) 
      throw new Error("Missing vapidPublicKey from config");
    return json.vapidPublicKey;
  }

  document
    .getElementById("enable")
    .onclick = async () => {
      try {
        const firstName = document
          .getElementById("firstName")
          .value
          .trim();
        const lastName = document
          .getElementById("lastName")
          .value
          .trim();
        const email = document
          .getElementById("email")
          .value
          .trim();

        if (!firstName || !lastName || !email) {
          setStatus("Please fill out all fields.", "error");
          return;
        }

        if (!("serviceWorker" in navigator)) {
          setStatus("Service workers are not supported on this device.", "error");
          return;
        }

        if (!("Notification" in window)) {
          setStatus("Notifications aren’t supported here. On iPhone: add to Home Screen and open from there.", "error");
          return;
        }

        setStatus("Loading config…");
        const VAPID_PUBLIC_KEY = await getVapidPublicKey();

        setStatus("Registering service worker…");
        const reg = await navigator
          .serviceWorker
          .register("/sw.js");

        setStatus("Requesting notification permission…");
        const perm = await Notification.requestPermission();
        if (perm !== "granted") {
          setStatus("Notification permission denied.", "error");
          return;
        }

        setStatus("Creating push subscription…");
        const subscription = await reg
          .pushManager
          .subscribe({userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)});

        setStatus("Saving subscription…");
        const res = await fetch("/.netlify/functions/push-subscribe", {
          method: "POST",
          headers: {
            "content-type": "application/json"
          },
          body: JSON.stringify({firstName, lastName, email, subscription})
        });

        if (!res.ok) 
          throw new Error(await res.text());
        
        setStatus("Subscribed successfully ✅", "success");
        setTimeout(() => location.href = "/", 600);
      } catch (err) {
        setStatus(
          err
          ?.message || "Something went wrong.",
        "error");
      }
    };
</script>
                </div>
            </main>

            <footer class="w-full p-6 mx-auto max-w-3xl text-center text-xs text-slate-300/80">
                &copy; 2025 Tyler J. Latshaw.  
                ECHL, the ECHL logo, team names, and team logos (including the Reading Royals)
                are trademarks and/or copyrighted works of their respective owners.
                This fan site is an independent, unofficial project and is not affiliated with,
                endorsed by, nor sponsored by the ECHL or any ECHL team.
             </footer>
        </div>
    </body>
</html>